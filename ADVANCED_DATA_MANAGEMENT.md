# é€²éšè³‡æ–™ç®¡ç†ç³»çµ±

## ğŸš€ ä¸»è¦æ”¹é€²

æœ¬æ¬¡æ›´æ–°å¯¦ä½œäº†å®Œæ•´çš„**ç‰ˆæœ¬ç®¡ç†**å’Œ**Web Worker æ”¯æ´**ï¼Œè§£æ±ºäº†å¤§é‡è³‡æ–™è™•ç†æ™‚çš„æ•ˆèƒ½å’Œä½¿ç”¨è€…é«”é©—å•é¡Œã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

1. **æ™ºæ…§è³‡æ–™ç‰ˆæœ¬ç®¡ç†**
   - è‡ªå‹•æ¸…ç†éæœŸè³‡æ–™ï¼Œä¿ç•™æœ€æ–°ç‰ˆæœ¬
   - åŸºæ–¼ `lastModified` å’Œ `dataVersion` çš„é«˜æ•ˆç´¢å¼•
   - æ”¯æ´æŒ‰æ—¥æœŸç¯„åœæ¸…ç†è³‡æ–™

2. **Web Worker éåŒæ­¥è™•ç†**
   - å¤§é‡è³‡æ–™æ“ä½œä¸é˜»å¡ UI åŸ·è¡Œç·’
   - æ”¯æ´æ•¸ç™¾ MB è³‡æ–™çš„æ‰¹æ¬¡è™•ç†
   - å¯¦æ™‚é€²åº¦å›å ±å’ŒéŒ¯èª¤è™•ç†

3. **æœ€ä½³åŒ– IndexedDB ç´¢å¼•**
   - `syncTimestamp` ç´¢å¼•ç”¨æ–¼å¿«é€Ÿæ™‚é–“ç¯„åœæŸ¥è©¢
   - `dataVersion` ç´¢å¼•æ”¯æ´ç‰ˆæœ¬ç®¡ç†
   - è¤‡åˆç´¢å¼• `lastModified_dataVersion` æå‡æŸ¥è©¢æ•ˆèƒ½

## ğŸ—ï¸ æ¶æ§‹å‡ç´š

### è³‡æ–™æ¨¡å‹å¢å¼·

```typescript
// CVE è¨˜éŒ„æ–°å¢ç‰ˆæœ¬ç®¡ç†æ¬„ä½
interface CveRecord {
  // ... åŸæœ‰æ¬„ä½
  dataVersion: string;      // è³‡æ–™ç‰ˆæœ¬æ¨™è¨˜ (YYYY-MM-DD)
  publishedYear: number;    // ç™¼å¸ƒå¹´ä»½ï¼Œå¿«é€Ÿç¯©é¸ç”¨
  syncTimestamp: number;    // åŒæ­¥æ™‚é–“æˆ³ï¼Œæ¸…ç†ä¾æ“š
}
```

### Web Worker æ¶æ§‹

```
ä¸»åŸ·è¡Œç·’                    Web Worker
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI æ“ä½œ    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  è³‡æ–™åº«æ¸…ç†      â”‚
â”‚  é€²åº¦é¡¯ç¤º   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  æ‰¹æ¬¡æ’å…¥/æ›´æ–°   â”‚
â”‚  éŒ¯èª¤è™•ç†   â”‚           â”‚  è³‡æ–™å£“ç¸®        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ–°å¢æœå‹™

### 1. DatabaseWorkerService
**è·è²¬**: ç®¡ç† Web Worker ç”Ÿå‘½é€±æœŸå’Œé€šè¨Š
```typescript
// æ™ºæ…§æ¸…ç†éæœŸè³‡æ–™
cleanupOldData(options: {
  keepDays?: number;
  dataVersion?: string;
  batchSize?: number;
})

// æ‰¹æ¬¡æ’å…¥/æ›´æ–°
bulkInsert(data: {
  cveRecords?: CveRecord[];
  cpeRecords?: CpeRecord[];
  batchSize?: number;
})

// æŒ‰ç‰ˆæœ¬åˆªé™¤
deleteByVersion(version: string)
```

### 2. å¢å¼·çš„ NvdDatabaseService
**æ–°å¢åŠŸèƒ½**: æ™ºæ…§è³‡æ–™æ›´æ–°
```typescript
// æ™ºæ…§æ›´æ–° - å…ˆæ¸…ç†å†è¼‰å…¥
smartDataUpdate(options: {
  cveRecords: CveRecord[];
  cpeRecords: CpeRecord[];
  newVersion: string;
  keepRecentDays?: number;
})

// ç‰ˆæœ¬ç®¡ç†
getDataVersions(): Observable<{
  version: string;
  count: number;
  syncTime: number;
}[]>

clearDataByVersion(version: string)
```

## ğŸ“Š æ•ˆèƒ½æå‡

### å¤§é‡è³‡æ–™è™•ç†æ”¹å–„

| æ“ä½œé¡å‹ | å‚³çµ±æ–¹å¼ | Web Worker æ–¹å¼ | æ”¹å–„å¹…åº¦ |
|---------|----------|-----------------|----------|
| æ¸…ç† 100k è¨˜éŒ„ | UI å‡çµ 5-10s | èƒŒæ™¯è™•ç†ï¼ŒUI é †æš¢ | â­â­â­â­â­ |
| æ’å…¥ 50k è¨˜éŒ„ | è¨˜æ†¶é«”å£“åŠ›é«˜ | åˆ†æ‰¹è™•ç†ç©©å®š | â­â­â­â­ |
| ç‰ˆæœ¬åˆ‡æ› | å…¨é‡æ›¿æ› | å¢é‡æ›´æ–° | â­â­â­â­ |

### ç´¢å¼•æŸ¥è©¢æœ€ä½³åŒ–

- **æ™‚é–“ç¯„åœæŸ¥è©¢**: `syncTimestamp` ç´¢å¼• â†’ 99% æŸ¥è©¢åŠ é€Ÿ
- **ç‰ˆæœ¬éæ¿¾**: `dataVersion` ç´¢å¼• â†’ æ‰¹æ¬¡åˆªé™¤æ•ˆç‡æå‡
- **å¹´ä»½ç¯©é¸**: `publishedYear` ç´¢å¼• â†’ æ­·å²è³‡æ–™å¿«é€Ÿå®šä½

## ğŸ¯ ä½¿ç”¨æµç¨‹

### è³‡æ–™åº«ç®¡ç†ä»‹é¢

1. **ç‹€æ…‹æª¢è¦–**
   - è³‡æ–™åº«çµ±è¨ˆï¼ˆCVE/CPE æ•¸é‡ã€ç‰ˆæœ¬åˆ†ä½ˆï¼‰
   - åŒæ­¥ç‹€æ…‹å’Œé€²åº¦
   - Web Worker å¯ç”¨æ€§æª¢æŸ¥

2. **ç¶­è­·æ“ä½œ**
   ```
   ğŸ“‹ åˆå§‹åŒæ­¥    â†’ ä¸‹è¼‰è¿‘å››å¹´å®Œæ•´è³‡æ–™
   ğŸ”„ å¢é‡åŒæ­¥    â†’ æ›´æ–°æœ€æ–°è®Šæ›´
   ğŸ§¹ æ™ºæ…§æ¸…ç†    â†’ Web Worker æ¸…ç†éæœŸè³‡æ–™  
   âŒ æ¸…é™¤è³‡æ–™åº«  â†’ å®Œå…¨é‡è¨­
   ```

3. **è‡ªå‹•åŒ–æµç¨‹**
   - æ¯æ—¥è‡ªå‹•å¢é‡æ›´æ–°
   - é€±æœŸæ€§æ¸…ç†éæœŸè³‡æ–™
   - éŒ¯èª¤è‡ªå‹•é‡è©¦æ©Ÿåˆ¶

### ç¨‹å¼æ•´åˆ

```typescript
// è¼‰å…¥æ–°è³‡æ–™å‰è‡ªå‹•æ¸…ç†
await databaseService.smartDataUpdate({
  cveRecords: newCveData,
  cpeRecords: newCpeData,
  newVersion: '2024-01-15',
  keepRecentDays: 7  // ä¿ç•™æœ€è¿‘ 7 å¤©è³‡æ–™
});

// æª¢æŸ¥ç‰ˆæœ¬åˆ†ä½ˆ
const versions = await databaseService.getDataVersions();
console.log('è³‡æ–™ç‰ˆæœ¬:', versions);

// æ‰‹å‹•æ¸…ç†ç‰¹å®šç‰ˆæœ¬
await databaseService.clearDataByVersion('2024-01-01');
```

## âš¡ æ™ºæ…§æ›´æ–°ç­–ç•¥

### è¼‰å…¥å‰æ¸…ç†æ©Ÿåˆ¶

```
æ–°è³‡æ–™è¼‰å…¥æµç¨‹ï¼š
1. æª¢æŸ¥å¯ç”¨ç©ºé–“
2. æ¸…ç†éæœŸè³‡æ–™ (keepRecentDays)
3. å£“ç¸®è³‡æ–™åº«é‡‹æ”¾ç©ºé–“
4. åˆ†æ‰¹è¼‰å…¥æ–°è³‡æ–™
5. æ›´æ–°ç‰ˆæœ¬æ¨™è¨˜
```

### å®¹éŒ¯è¨­è¨ˆ

- **Web Worker ä¸å¯ç”¨**: è‡ªå‹•å›é€€åˆ°ä¸»åŸ·è¡Œç·’è™•ç†
- **è³‡æ–™æå£**: ç‰ˆæœ¬å›æ»¾æ©Ÿåˆ¶
- **ç©ºé–“ä¸è¶³**: åˆ†éšæ®µæ¸…ç†ç­–ç•¥
- **ç¶²è·¯ä¸­æ–·**: æ–·é»çºŒå‚³æ”¯æ´

## ğŸ” ç›£æ§èˆ‡é™¤éŒ¯

### é€²åº¦è¿½è¹¤

æ‰€æœ‰é•·æ™‚é–“æ“ä½œéƒ½æä¾›å³æ™‚é€²åº¦ï¼š
```typescript
workerService.getProgress().subscribe(progress => {
  console.log(`${progress.phase}: ${progress.percentage}%`);
  console.log(`è™•ç†ä¸­: ${progress.message}`);
});
```

### éŒ¯èª¤è™•ç†

```typescript
try {
  await smartDataUpdate(options);
} catch (error) {
  if (error.message.includes('Worker')) {
    // å›é€€åˆ°ä¸»åŸ·è¡Œç·’
    return fallbackMainThreadUpdate(options);
  }
  throw error;
}
```

## ğŸ›ï¸ é…ç½®é¸é …

### æ¸…ç†ç­–ç•¥é…ç½®
```typescript
const cleanupOptions = {
  keepDays: 7,        // ä¿ç•™å¤©æ•¸
  batchSize: 1000,    // æ‰¹æ¬¡å¤§å°
  maxMemoryMB: 100    // è¨˜æ†¶é«”ä½¿ç”¨ä¸Šé™
};
```

### Worker é…ç½®
```typescript
const workerOptions = {
  timeout: 300000,    // 5åˆ†é˜è¶…æ™‚
  retryCount: 3,      // é‡è©¦æ¬¡æ•¸
  progressInterval: 100 // é€²åº¦å›å ±é–“éš”
};
```

## ğŸ“ˆ æœªä¾†è¦åŠƒ

- [ ] **å£“ç¸®æ¼”ç®—æ³•**: å¯¦ä½œæ›´é«˜æ•ˆçš„è³‡æ–™å£“ç¸®
- [ ] **åˆ†æ•£å¼å¿«å–**: æ”¯æ´å¤šç¯€é»è³‡æ–™åŒæ­¥
- [ ] **é æ¸¬æ¸…ç†**: åŸºæ–¼ä½¿ç”¨æ¨¡å¼çš„æ™ºæ…§æ¸…ç†
- [ ] **å¢é‡ç´¢å¼•**: å‹•æ…‹ç´¢å¼•å»ºç«‹å’Œç¶­è­·
- [ ] **æ•ˆèƒ½ç›£æ§**: è©³ç´°çš„æ“ä½œæ™‚é–“å’Œè³‡æºä½¿ç”¨è¿½è¹¤

é€™å€‹é€²éšç³»çµ±ç¢ºä¿äº†å³ä½¿è™•ç†æ•¸ç™¾ MB çš„ NVD è³‡æ–™ï¼Œä½¿ç”¨è€…ä»‹é¢ä»ç„¶ä¿æŒæµæš¢éŸ¿æ‡‰ï¼ŒåŒæ™‚æä¾›äº†å¼·å¤§çš„è³‡æ–™ç‰ˆæœ¬ç®¡ç†èƒ½åŠ›ï¼