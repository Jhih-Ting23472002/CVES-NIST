# 本地 NVD 掃描功能設定指南

## 概述

本專案已整合了本地 NVD 資料庫掃描功能，提供以下優勢：

- **快速掃描**：本地資料庫查詢，無需等待 API 延遲
- **無 API 限制**：不受 NIST API 速率限制約束
- **離線支援**：資料同步後可在離線環境使用
- **自動更新**：支援每日增量更新機制

## 核心架構

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   NVD 靜態檔    │──▶ │  IndexedDB 本地   │──▶ │   本地掃描服務   │
│  (近四年資料)    │    │     資料庫        │    │                │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                ▲
                                │
                       ┌──────────────────┐
                       │  增量更新服務     │
                       │ (每日同步新資料)  │
                       └──────────────────┘
```

## 新增服務

### 1. NvdDownloadService
負責下載 NVD 資料檔案：
- 近四年完整資料下載
- 增量更新檔案 (modified.json.gz)
- 支援 gzip 解壓縮
- 網路連線測試

### 2. NvdParserService  
負責解析 NVD JSON 資料：
- 串流解析大型 JSON 檔案
- 分批處理避免記憶體溢出
- 支援新舊 API 格式
- CPE 名稱映射套件名稱

### 3. NvdDatabaseService
負責 IndexedDB 操作：
- CVE/CPE 記錄儲存
- 多策略查詢 (精確/模糊/CPE)
- 版本範圍比對
- 資料庫統計資訊

### 4. NvdSyncService
負責同步管理：
- 初始完整同步
- 每日增量更新
- 自動排程機制
- 同步進度回報

### 5. LocalScanService
負責本地掃描：
- 快速套件漏洞查詢
- 批次掃描支援
- 風險評估分析
- 與 API 結果比較

## 使用方式

### 初始設定

1. **訪問資料庫管理頁面**：
   ```
   http://localhost:4200/database
   ```

2. **執行初始同步**：
   - 點擊「初始同步」按鈕
   - 系統會下載近四年 NVD 資料
   - 首次同步約需 10-30 分鐘

3. **檢查同步狀態**：
   - 查看資料庫統計資訊
   - 確認 CVE 記錄數量 > 0

### 掃描流程

掃描服務現在會自動選擇最佳方案：

1. **優先使用本地掃描**（如果資料庫已就緒）
2. **回退至 API 掃描**（如果本地掃描失敗）
3. **混合結果快取**（結合本地和 API 結果）

### 資料維護

- **自動更新**：每 24 小時自動檢查並下載增量更新
- **手動同步**：可在資料庫管理頁面手動觸發同步
- **清除資料**：支援清除本地資料庫重新開始

## 快取策略更新

快取系統已升級支援多來源快取：

- **API 快取**：24 小時 TTL
- **本地快取**：7 天 TTL（本地結果更穩定）
- **智慧清理**：優先保留本地掃描結果
- **來源統計**：追蹤不同來源的快取效能

## 效能提升

相比純 API 掃描，本地掃描提供：

- **速度提升**：掃描時間從分鐘級降至秒級
- **穩定性**：無網路延遲和 API 限制影響
- **準確性**：基於完整 NVD 資料集，覆蓋更全面
- **使用體驗**：即時回應，支援大批量掃描

## 故障排除

### 問題：初始同步失敗
解決方案：
1. 檢查網路連線
2. 確認 NIST 服務狀態
3. 清除瀏覽器快取後重試

### 問題：本地掃描結果為空
解決方案：
1. 確認資料庫已完成同步
2. 檢查套件名稱拼寫
3. 嘗試手動同步最新資料

### 問題：掃描速度仍然很慢
解決方案：
1. 確認使用的是本地掃描（檢查控制台日誌）
2. 清理瀏覽器 IndexedDB
3. 重新執行初始同步

## 監控指標

可在資料庫管理頁面查看：

- **資料庫統計**：CVE/CPE 記錄數量、資料年度
- **同步狀態**：最後同步時間、下次同步時間
- **快取效能**：命中率、來源分佈、存取統計
- **連線狀態**：NVD 服務連線測試結果

## 開發注意事項

1. **漸進式升級**：系統自動在本地和 API 掃描間切換，無需修改現有代碼
2. **向後相容**：保持與現有掃描 API 介面一致
3. **錯誤處理**：本地掃描失敗時自動回退至 API 掃描
4. **測試支援**：提供 API 結果比較功能驗證準確性

## 未來規劃

- [ ] 支援更多年份的歷史資料
- [ ] 增加 CPE 字典自動更新
- [ ] 實作分散式快取機制
- [ ] 加入機器學習增強匹配準確性