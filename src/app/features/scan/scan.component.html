<div class="scan-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>security</mat-icon>
        {{ getScanTitle() }}
      </mat-card-title>
      <mat-card-subtitle>
        {{ getScanSubtitle() }}
      </mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <div class="progress-section" *ngIf="isScanning">
        <div class="progress-info">
          <p>{{ scanProgress.currentPackage }}</p>
          <p>進度: {{ scanProgress.current }} / {{ scanProgress.total }}</p>
        </div>
        <mat-progress-bar 
          mode="determinate" 
          [value]="scanProgress.percentage">
        </mat-progress-bar>
        <p class="progress-text">{{ scanProgress.percentage.toFixed(1) }}% 完成</p>
      </div>
      
      <div class="results-section" *ngIf="scanCompleted && scanResults.length > 0">
        <div class="results-summary">
          <h3>掃描結果摘要</h3>
          <div class="summary-stats">
            <div class="stat critical" *ngIf="getSeverityCount('CRITICAL') > 0">
              <span class="count">{{ getSeverityCount('CRITICAL') }}</span>
              <span class="label">嚴重</span>
            </div>
            <div class="stat high" *ngIf="getSeverityCount('HIGH') > 0">
              <span class="count">{{ getSeverityCount('HIGH') }}</span>
              <span class="label">高風險</span>
            </div>
            <div class="stat medium" *ngIf="getSeverityCount('MEDIUM') > 0">
              <span class="count">{{ getSeverityCount('MEDIUM') }}</span>
              <span class="label">中風險</span>
            </div>
            <div class="stat low" *ngIf="getSeverityCount('LOW') > 0">
              <span class="count">{{ getSeverityCount('LOW') }}</span>
              <span class="label">低風險</span>
            </div>
            <div class="stat safe" *ngIf="getSafePackagesCount() > 0">
              <span class="count">{{ getSafePackagesCount() }}</span>
              <span class="label">安全</span>
            </div>
          </div>
        </div>
        
        <div class="results-table" *ngIf="getVulnerablePackages().length > 0">
          <h4>發現漏洞的套件</h4>
          <table mat-table [dataSource]="getVulnerablePackages()" class="vulnerability-table">
            <ng-container matColumnDef="package">
              <th mat-header-cell *matHeaderCellDef>套件名稱</th>
              <td mat-cell *matCellDef="let result">{{ result.packageName }}</td>
            </ng-container>
            
            <ng-container matColumnDef="vulnerabilities">
              <th mat-header-cell *matHeaderCellDef>漏洞數量</th>
              <td mat-cell *matCellDef="let result">{{ result.vulnerabilities.length }}</td>
            </ng-container>
            
            <ng-container matColumnDef="highestSeverity">
              <th mat-header-cell *matHeaderCellDef>最高風險</th>
              <td mat-cell *matCellDef="let result">
                <span [class]="'severity-badge ' + getHighestSeverity(result.vulnerabilities).toLowerCase()">
                  {{ getHighestSeverity(result.vulnerabilities) }}
                </span>
              </td>
            </ng-container>
            
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </div>
      
      <div class="no-vulnerabilities" *ngIf="scanCompleted && getVulnerablePackages().length === 0">
        <mat-icon class="success-icon">verified</mat-icon>
        <h3>太好了！沒有發現已知漏洞</h3>
        <p>所有 {{ packages.length }} 個套件都沒有在 NIST CVE 資料庫中找到相關漏洞記錄。</p>
      </div>
    </mat-card-content>
    
    <mat-card-actions>
      <button mat-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        返回上傳
      </button>
      <button mat-raised-button 
              color="primary" 
              *ngIf="!isScanning && !scanCompleted" 
              (click)="startScan()"
              [disabled]="packages.length === 0">
        <mat-icon>play_arrow</mat-icon>
        開始掃描
      </button>
      <button mat-raised-button 
              color="accent" 
              *ngIf="scanCompleted && getVulnerablePackages().length > 0" 
              (click)="viewReport()">
        <mat-icon>assessment</mat-icon>
        檢視詳細報告
      </button>
    </mat-card-actions>
  </mat-card>
</div>