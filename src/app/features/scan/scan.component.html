<div class="scan-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>security</mat-icon>
        {{ getScanTitle() }}
      </mat-card-title>
      <mat-card-subtitle>
        {{ getScanSubtitle() }}
      </mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <!-- 背景掃描設定區域 -->
      <div class="scan-options" *ngIf="!currentTask && !isScanning && !scanCompleted">
        <h3>掃描設定</h3>
        
        <div class="background-scan-option">
          <mat-slide-toggle 
            [(ngModel)]="useBackgroundScan"
            [disabled]="isScanning">
            背景掃描模式
          </mat-slide-toggle>
          <mat-icon 
            matTooltip="背景掃描允許您在掃描進行時繼續使用其他功能，掃描完成時會收到通知"
            class="info-icon">
            info
          </mat-icon>
        </div>
        
        <div class="scan-config" *ngIf="useBackgroundScan">
          <p class="config-description">
            掃描模式：{{ getScanConfigDescription() }}
          </p>
          <p class="time-estimate">
            預估時間：約 {{ fileParserService.estimateScanTime(packages).estimatedMinutes }} 分鐘
          </p>
        </div>
      </div>

      <!-- 背景任務控制區域 -->
      <div class="background-task-controls" *ngIf="currentTask">
        <div class="task-info">
          <h4>{{ currentTask.name }}</h4>
          <p class="task-description">
            創建於：{{ currentTask.createdAt | date:'short' }}
            <span *ngIf="currentTask.startedAt"> | 開始於：{{ currentTask.startedAt | date:'short' }}</span>
            <span *ngIf="currentTask.completedAt"> | 完成於：{{ currentTask.completedAt | date:'short' }}</span>
          </p>
          <p class="task-status" [class]="'status-' + currentTask.status">
            狀態：{{ getTaskStatusText() }}
          </p>
        </div>

        <div class="task-controls" *ngIf="['running', 'paused'].includes(currentTask.status)">
          <button mat-button 
                  color="warn"
                  *ngIf="currentTask.status === 'running'"
                  (click)="pauseBackgroundScan()">
            <mat-icon>pause</mat-icon>
            暫停
          </button>
          <button mat-button 
                  color="primary"
                  *ngIf="currentTask.status === 'paused'"
                  (click)="resumeBackgroundScan()">
            <mat-icon>play_arrow</mat-icon>
            繼續
          </button>
          <button mat-button 
                  color="warn"
                  (click)="cancelBackgroundScan()">
            <mat-icon>stop</mat-icon>
            取消
          </button>
        </div>
      </div>
      <!-- 進度顯示區域（前景掃描或背景任務進度） -->
      <div class="progress-section" *ngIf="isScanning || (currentTask && ['running', 'paused'].includes(currentTask.status))">
        <div class="progress-info">
          <p *ngIf="currentTask; else foregroundProgress">
            {{ currentTask.progress.currentPackage }}
          </p>
          <ng-template #foregroundProgress>
            <p>{{ scanProgress.currentPackage }}</p>
          </ng-template>
          
          <p *ngIf="currentTask; else foregroundProgressCount">
            進度: {{ currentTask.progress.current }} / {{ currentTask.progress.total }}
          </p>
          <ng-template #foregroundProgressCount>
            <p>進度: {{ scanProgress.current }} / {{ scanProgress.total }}</p>
          </ng-template>
        </div>
        
        <mat-progress-bar 
          mode="determinate" 
          [value]="getProgressPercentage()">
        </mat-progress-bar>
        
        <p class="progress-text">{{ getProgressPercentage().toFixed(1) }}% 完成</p>
        
        <p class="progress-mode" *ngIf="currentTask">
          <mat-icon class="background-icon">cloud</mat-icon>
          背景掃描進行中 - 您可以繼續使用其他功能
        </p>
      </div>
      
      <!-- 結果顯示區域 -->
      <div class="results-section" *ngIf="(scanCompleted && scanResults.length > 0) || (currentTask?.status === 'completed' && currentTask?.results)">
        <div class="results-summary">
          <h3>掃描結果摘要</h3>
          <div class="summary-stats">
            <div class="stat critical" *ngIf="getSeverityCount('CRITICAL') > 0">
              <span class="count">{{ getSeverityCount('CRITICAL') }}</span>
              <span class="label">嚴重</span>
            </div>
            <div class="stat high" *ngIf="getSeverityCount('HIGH') > 0">
              <span class="count">{{ getSeverityCount('HIGH') }}</span>
              <span class="label">高風險</span>
            </div>
            <div class="stat medium" *ngIf="getSeverityCount('MEDIUM') > 0">
              <span class="count">{{ getSeverityCount('MEDIUM') }}</span>
              <span class="label">中風險</span>
            </div>
            <div class="stat low" *ngIf="getSeverityCount('LOW') > 0">
              <span class="count">{{ getSeverityCount('LOW') }}</span>
              <span class="label">低風險</span>
            </div>
            <div class="stat safe" *ngIf="getSafePackagesCount() > 0">
              <span class="count">{{ getSafePackagesCount() }}</span>
              <span class="label">安全</span>
            </div>
          </div>
        </div>
        
        <div class="results-table" *ngIf="getVulnerablePackages().length > 0">
          <h4>發現漏洞的套件</h4>
          <table mat-table [dataSource]="getVulnerablePackages()" class="vulnerability-table">
            <ng-container matColumnDef="package">
              <th mat-header-cell *matHeaderCellDef>套件名稱</th>
              <td mat-cell *matCellDef="let result">{{ result.packageName }}</td>
            </ng-container>
            
            <ng-container matColumnDef="vulnerabilities">
              <th mat-header-cell *matHeaderCellDef>漏洞數量</th>
              <td mat-cell *matCellDef="let result">{{ result.vulnerabilities.length }}</td>
            </ng-container>
            
            <ng-container matColumnDef="highestSeverity">
              <th mat-header-cell *matHeaderCellDef>最高風險</th>
              <td mat-cell *matCellDef="let result">
                <span [class]="'severity-badge ' + getHighestSeverity(result.vulnerabilities).toLowerCase()">
                  {{ getHighestSeverity(result.vulnerabilities) }}
                </span>
              </td>
            </ng-container>
            
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </div>
      
      <!-- 無漏洞顯示 -->
      <div class="no-vulnerabilities" *ngIf="(scanCompleted && getVulnerablePackages().length === 0) || (currentTask?.status === 'completed' && (!currentTask?.results || getVulnerablePackages().length === 0))">
        <mat-icon class="success-icon">verified</mat-icon>
        <h3>太好了！沒有發現已知漏洞</h3>
        <p>所有 {{ packages.length }} 個套件都沒有在 NIST CVE 資料庫中找到相關漏洞記錄。</p>
      </div>
    </mat-card-content>
    
    <mat-card-actions>
      <button mat-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        返回上傳
      </button>
      
      <!-- 開始掃描按鈕 -->
      <button mat-raised-button 
              color="primary" 
              *ngIf="!currentTask && !isScanning && !scanCompleted" 
              (click)="startScan()"
              [disabled]="packages.length === 0">
        <mat-icon>{{ useBackgroundScan ? 'cloud_queue' : 'play_arrow' }}</mat-icon>
        {{ useBackgroundScan ? '開始背景掃描' : '開始掃描' }}
      </button>
      
      <!-- 檢視報告按鈕 -->
      <button mat-raised-button 
              color="accent" 
              *ngIf="canViewReport()" 
              (click)="viewReport()">
        <mat-icon>assessment</mat-icon>
        檢視詳細報告
      </button>
      
      <!-- 背景任務管理按鈕 -->
      <button mat-button 
              color="primary"
              *ngIf="backgroundScanService.hasRunningTask() && !currentTask"
              routerLink="/background-tasks">
        <mat-icon>list_alt</mat-icon>
        查看背景任務
      </button>
    </mat-card-actions>
  </mat-card>
</div>