<div class="upload-container">
  <mat-card class="upload-card">
    <mat-card-header>
      <div class="header-content">
        <div class="title-section">
          <mat-card-title>
            <mat-icon>security</mat-icon>
            安全掃描工具
          </mat-card-title>
          <mat-card-subtitle>檢查專案套件是否有安全漏洞</mat-card-subtitle>
        </div>
        <div class="header-actions">
          <button mat-stroked-button 
                  color="primary"
                  routerLink="/database"
                  matTooltip="管理本地 NVD 資料庫">
            <mat-icon>storage</mat-icon>
            資料庫管理
          </button>
          <button mat-icon-button 
                  color="primary"
                  routerLink="/background-tasks"
                  matTooltip="查看背景任務"
                  *ngIf="backgroundScanService.getTaskStats().active > 0 || backgroundScanService.getTaskStats().completed > 0">
            <mat-icon matBadge="{{ backgroundScanService.getTaskStats().active }}" 
                      [matBadgeHidden]="backgroundScanService.getTaskStats().active === 0"
                      matBadgeColor="accent">
              cloud_queue
            </mat-icon>
          </button>
        </div>
      </div>
    </mat-card-header>

    <mat-card-content>
      <mat-stepper #stepper linear>
        <!-- 步驟 1: 檔案選擇 -->
        <mat-step [stepControl]="fileSelectionForm" label="選擇檔案">
          <form [formGroup]="fileSelectionForm">
            <div class="upload-zone" 
                 [class.drag-over]="isDragOver"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (drop)="onDrop($event)"
                 (click)="triggerFileInput()">
              
              <input #fileInput 
                     type="file" 
                     accept=".json"
                     (change)="onFileSelected($event)"
                     style="display: none;">
              
              <div class="upload-content">
                <mat-icon class="upload-icon">upload</mat-icon>
                <h3>拖拽檔案或點擊選擇</h3>
                <p>上傳 <strong>package.json</strong> 或 <strong>package-lock.json</strong></p>
                
                <div class="feature-highlights">
                  <div class="feature-item">
                    <mat-icon>speed</mat-icon>
                    <span>快速掃描</span>
                  </div>
                  <div class="feature-item">
                    <mat-icon>offline_bolt</mat-icon>
                    <span>離線使用</span>
                  </div>
                  <div class="feature-item">
                    <mat-icon>shield</mat-icon>
                    <span>安全檢測</span>
                  </div>
                </div>
                
                <p class="file-size-hint">檔案大小 < 10MB</p>
              </div>
            </div>

            <div class="selected-file" *ngIf="selectedFile">
              <mat-icon>description</mat-icon>
              <span>{{ selectedFile.name }}</span>
              <span class="file-size">({{ formatFileSize(selectedFile.size) }})</span>
              <button mat-icon-button (click)="removeFile()" matTooltip="移除檔案">
                <mat-icon>close</mat-icon>
              </button>
            </div>


            <div class="step-actions">
              <button mat-raised-button 
                      color="primary" 
                      [disabled]="!selectedFile"
                      (click)="validateFile()">
                <mat-icon>check_circle</mat-icon>
                驗證檔案
              </button>
            </div>
          </form>
        </mat-step>

        <!-- 步驟 2: 檔案驗證 -->
        <mat-step [stepControl]="validationForm" label="檔案驗證">
          <form [formGroup]="validationForm">
            <div class="validation-section">
              <div class="validation-status" *ngIf="validationResult">
                <div class="status-header" [class]="validationResult.isValid ? 'valid' : 'invalid'">
                  <mat-icon>{{ validationResult.isValid ? 'check_circle' : 'error_outline' }}</mat-icon>
                  <h3>{{ validationResult.isValid ? '檔案驗證成功' : '檔案驗證失敗' }}</h3>
                </div>

                <div class="validation-details" *ngIf="validationResult.isValid">
                  <p>✅ 檔案格式正確，可以正常讀取</p>
                  <p>✅ 找到套件相依性資訊</p>
                  <p>✅ 偵測到 {{ packages.length }} 個需要檢查的套件</p>
                </div>

                <div class="validation-errors" *ngIf="!validationResult.isValid">
                  <h4>❌ 檔案有問題，需要修正：</h4>
                  <ul>
                    <li *ngFor="let error of validationResult.errors">{{ error }}</li>
                  </ul>
                  <div class="error-help">
                    <p><strong>💡 解決建議：</strong></p>
                    <p>• 確認是從 Node.js 專案中選取的檔案</p>
                    <p>• 檔案內容要是有效的 JSON 格式</p>
                    <p>• 檔案中要有 dependencies 或 devDependencies</p>
                  </div>
                </div>
              </div>

              <div class="loading-spinner" *ngIf="isValidating">
                <mat-spinner diameter="50"></mat-spinner>
                <p>正在驗證檔案...</p>
              </div>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                上一步
              </button>
              <button mat-raised-button 
                      color="primary" 
                      [disabled]="!validationResult?.isValid"
                      matStepperNext>
                <mat-icon>arrow_forward</mat-icon>
                下一步
              </button>
            </div>
          </form>
        </mat-step>

        <!-- 步驟 3: 套件清單 -->
        <mat-step label="套件清單">
          <div class="packages-section">
            <div class="packages-summary">
              <h3>檢測到的套件</h3>
              <div class="summary-chips">
                <mat-chip-set>
                  <mat-chip class="dependency-chip">
                    <mat-icon>folder</mat-icon>
                    主要相依 {{ getDependencyCount('dependency') }}
                  </mat-chip>
                  <mat-chip class="dev-dependency-chip">
                    <mat-icon>build</mat-icon>
                    開發相依 {{ getDependencyCount('devDependency') }}
                  </mat-chip>
                  <mat-chip class="transitive-chip" *ngIf="isPackageLockFile()">
                    <mat-icon>account_tree</mat-icon>
                    間接相依 {{ getDependencyCount('transitive') }}
                  </mat-chip>
                </mat-chip-set>
              </div>

              <!-- 掃描模式選擇 -->
              <div class="scan-mode-section" *ngIf="packages.length > 0">
                <mat-expansion-panel>
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon>settings</mat-icon>
                      掃描設定
                    </mat-panel-title>
                    <mat-panel-description>
                      {{ getCurrentModeDescription() }}
                    </mat-panel-description>
                  </mat-expansion-panel-header>
                  
                  <div class="scan-mode-content">
                    <h4>掃描範圍：</h4>
                    
                    <mat-radio-group 
                      [value]="currentScanConfig.mode" 
                      (change)="onScanModeChange($event.value)">
                      
                      <div class="scan-mode-options">
                        <mat-radio-button 
                          *ngFor="let mode of scanModes" 
                          [value]="mode.value"
                          class="scan-mode-option">
                          
                          <div class="mode-content">
                            <div class="mode-header">
                              <mat-icon [class]="'mode-icon-' + mode.value">{{ mode.icon }}</mat-icon>
                              <span class="mode-label">{{ mode.label }}</span>
                              <span class="mode-badge" *ngIf="mode.value === 'balanced'">推薦</span>
                            </div>
                            <p class="mode-description">{{ getSimplifiedModeDescription(mode.value) }}</p>
                          </div>
                        </mat-radio-button>
                      </div>
                    </mat-radio-group>

                    <div class="scan-stats" *ngIf="allPackages.length > 0">
                      <mat-icon>info</mat-icon>
                      <span>{{ getScanStats() }}</span>
                      <span *ngIf="estimatedScanTime" class="time-estimate">
                        (預估時間: {{ estimatedScanTime.estimatedMinutes }} 分鐘)
                      </span>
                    </div>
                  </div>
                </mat-expansion-panel>
              </div>

            </div>

            <!-- 套件清單折疊面板 -->
            <div class="packages-list-section">
              <mat-expansion-panel [expanded]="showPackagesList" (expandedChange)="showPackagesList = $event">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon>list_alt</mat-icon>
                    套件詳細清單
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ showPackagesList ? '隱藏' : '顯示' }} {{ packages.length }} 個套件的詳細資訊
                  </mat-panel-description>
                </mat-expansion-panel-header>
                
                <!-- 虛擬滾動套件表格 -->
                <div class="virtual-scroll-container">
                  <cdk-virtual-scroll-viewport itemSize="48" minBufferPx="200" maxBufferPx="400" class="packages-viewport">
                    <div class="packages-table-header">
                      <div class="header-row">
                        <div class="header-cell name-column">套件名稱</div>
                        <div class="header-cell version-column">版本</div>
                        <div class="header-cell type-column">類型</div>
                      </div>
                    </div>
                    
                    <div *cdkVirtualFor="let package of packages; trackBy: trackByPackageName" 
                         class="package-row">
                      <div class="package-cell name-column" [matTooltip]="package.name">
                        {{ package.name }}
                      </div>
                      <div class="package-cell version-column">
                        {{ package.version }}
                      </div>
                      <div class="package-cell type-column">
                        <mat-chip [class]="'type-' + package.type" class="package-type-chip">
                          {{ package.type === 'dependency' ? '正式' : 
                             package.type === 'devDependency' ? '開發' : '間接' }}
                        </mat-chip>
                      </div>
                    </div>
                  </cdk-virtual-scroll-viewport>
                </div>
              </mat-expansion-panel>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                上一步
              </button>
              <button mat-raised-button 
                      color="accent" 
                      (click)="startScan()"
                      [disabled]="packages.length === 0">
                <mat-icon>play_arrow</mat-icon>
                開始掃描 ({{ packages.length }} 個套件)
              </button>
            </div>
          </div>
        </mat-step>
      </mat-stepper>
    </mat-card-content>
  </mat-card>

  <!-- 幫助資訊 -->
  <mat-card class="help-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>help_outline</mat-icon>
        使用步驟
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="help-steps">
        <div class="help-step">
          <div class="step-number">1</div>
          <div>
            <h4>上傳檔案</h4>
            <p>選擇專案中的 package.json</p>
          </div>
        </div>
        <div class="help-step">
          <div class="step-number">2</div>
          <div>
            <h4>開始掃描</h4>
            <p>點擊掃描按鈕即可</p>
          </div>
        </div>
      </div>
      
      <div class="faq-section">
        <div class="faq-item">
          <strong>💡 檔案不會上傳到伺服器，在本地處理</strong>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>