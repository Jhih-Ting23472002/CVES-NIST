<div class="upload-container">
  <mat-card class="upload-card">
    <mat-card-header>
      <div class="header-content">
        <div class="title-section">
          <mat-card-title>
            <mat-icon>security</mat-icon>
            å®‰å…¨æƒæå·¥å…·
          </mat-card-title>
          <mat-card-subtitle>æª¢æŸ¥å°ˆæ¡ˆå¥—ä»¶æ˜¯å¦æœ‰å®‰å…¨æ¼æ´</mat-card-subtitle>
        </div>
        <div class="header-actions">
          <button mat-stroked-button 
                  color="primary"
                  routerLink="/database"
                  matTooltip="ç®¡ç†æœ¬åœ° NVD è³‡æ–™åº«">
            <mat-icon>storage</mat-icon>
            è³‡æ–™åº«ç®¡ç†
          </button>
          <button mat-icon-button 
                  color="primary"
                  routerLink="/background-tasks"
                  matTooltip="æŸ¥çœ‹èƒŒæ™¯ä»»å‹™"
                  *ngIf="backgroundScanService.getTaskStats().active > 0 || backgroundScanService.getTaskStats().completed > 0">
            <mat-icon matBadge="{{ backgroundScanService.getTaskStats().active }}" 
                      [matBadgeHidden]="backgroundScanService.getTaskStats().active === 0"
                      matBadgeColor="accent">
              cloud_queue
            </mat-icon>
          </button>
        </div>
      </div>
    </mat-card-header>

    <mat-card-content>
      <mat-stepper #stepper linear>
        <!-- æ­¥é©Ÿ 1: æª”æ¡ˆé¸æ“‡ -->
        <mat-step [stepControl]="fileSelectionForm" label="é¸æ“‡æª”æ¡ˆ">
          <form [formGroup]="fileSelectionForm">
            <div class="upload-zone" 
                 [class.drag-over]="isDragOver"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (drop)="onDrop($event)"
                 (click)="triggerFileInput()">
              
              <input #fileInput 
                     type="file" 
                     accept=".json"
                     (change)="onFileSelected($event)"
                     style="display: none;">
              
              <div class="upload-content">
                <mat-icon class="upload-icon">upload</mat-icon>
                <h3>æ‹–æ‹½æª”æ¡ˆæˆ–é»æ“Šé¸æ“‡</h3>
                <p>ä¸Šå‚³ <strong>package.json</strong> æˆ– <strong>package-lock.json</strong></p>
                
                <div class="feature-highlights">
                  <div class="feature-item">
                    <mat-icon>speed</mat-icon>
                    <span>å¿«é€Ÿæƒæ</span>
                  </div>
                  <div class="feature-item">
                    <mat-icon>offline_bolt</mat-icon>
                    <span>é›¢ç·šä½¿ç”¨</span>
                  </div>
                  <div class="feature-item">
                    <mat-icon>shield</mat-icon>
                    <span>å®‰å…¨æª¢æ¸¬</span>
                  </div>
                </div>
                
                <p class="file-size-hint">æª”æ¡ˆå¤§å° < 10MB</p>
              </div>
            </div>

            <div class="selected-file" *ngIf="selectedFile">
              <mat-icon>description</mat-icon>
              <span>{{ selectedFile.name }}</span>
              <span class="file-size">({{ formatFileSize(selectedFile.size) }})</span>
              <button mat-icon-button (click)="removeFile()" matTooltip="ç§»é™¤æª”æ¡ˆ">
                <mat-icon>close</mat-icon>
              </button>
            </div>


            <div class="step-actions">
              <button mat-raised-button 
                      color="primary" 
                      [disabled]="!selectedFile"
                      (click)="validateFile()">
                <mat-icon>check_circle</mat-icon>
                é©—è­‰æª”æ¡ˆ
              </button>
            </div>
          </form>
        </mat-step>

        <!-- æ­¥é©Ÿ 2: æª”æ¡ˆé©—è­‰ -->
        <mat-step [stepControl]="validationForm" label="æª”æ¡ˆé©—è­‰">
          <form [formGroup]="validationForm">
            <div class="validation-section">
              <div class="validation-status" *ngIf="validationResult">
                <div class="status-header" [class]="validationResult.isValid ? 'valid' : 'invalid'">
                  <mat-icon>{{ validationResult.isValid ? 'check_circle' : 'error_outline' }}</mat-icon>
                  <h3>{{ validationResult.isValid ? 'æª”æ¡ˆé©—è­‰æˆåŠŸ' : 'æª”æ¡ˆé©—è­‰å¤±æ•—' }}</h3>
                </div>

                <div class="validation-details" *ngIf="validationResult.isValid">
                  <p>âœ… æª”æ¡ˆæ ¼å¼æ­£ç¢ºï¼Œå¯ä»¥æ­£å¸¸è®€å–</p>
                  <p>âœ… æ‰¾åˆ°å¥—ä»¶ç›¸ä¾æ€§è³‡è¨Š</p>
                  <p>âœ… åµæ¸¬åˆ° {{ packages.length }} å€‹éœ€è¦æª¢æŸ¥çš„å¥—ä»¶</p>
                </div>

                <div class="validation-errors" *ngIf="!validationResult.isValid">
                  <h4>âŒ æª”æ¡ˆæœ‰å•é¡Œï¼Œéœ€è¦ä¿®æ­£ï¼š</h4>
                  <ul>
                    <li *ngFor="let error of validationResult.errors">{{ error }}</li>
                  </ul>
                  <div class="error-help">
                    <p><strong>ğŸ’¡ è§£æ±ºå»ºè­°ï¼š</strong></p>
                    <p>â€¢ ç¢ºèªæ˜¯å¾ Node.js å°ˆæ¡ˆä¸­é¸å–çš„æª”æ¡ˆ</p>
                    <p>â€¢ æª”æ¡ˆå…§å®¹è¦æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼</p>
                    <p>â€¢ æª”æ¡ˆä¸­è¦æœ‰ dependencies æˆ– devDependencies</p>
                  </div>
                </div>
              </div>

              <div class="loading-spinner" *ngIf="isValidating">
                <mat-spinner diameter="50"></mat-spinner>
                <p>æ­£åœ¨é©—è­‰æª”æ¡ˆ...</p>
              </div>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                ä¸Šä¸€æ­¥
              </button>
              <button mat-raised-button 
                      color="primary" 
                      [disabled]="!validationResult?.isValid"
                      matStepperNext>
                <mat-icon>arrow_forward</mat-icon>
                ä¸‹ä¸€æ­¥
              </button>
            </div>
          </form>
        </mat-step>

        <!-- æ­¥é©Ÿ 3: å¥—ä»¶æ¸…å–® -->
        <mat-step label="å¥—ä»¶æ¸…å–®">
          <div class="packages-section">
            <div class="packages-summary">
              <h3>æª¢æ¸¬åˆ°çš„å¥—ä»¶</h3>
              <div class="summary-chips">
                <mat-chip-set>
                  <mat-chip class="dependency-chip">
                    <mat-icon>folder</mat-icon>
                    ä¸»è¦ç›¸ä¾ {{ getDependencyCount('dependency') }}
                  </mat-chip>
                  <mat-chip class="dev-dependency-chip">
                    <mat-icon>build</mat-icon>
                    é–‹ç™¼ç›¸ä¾ {{ getDependencyCount('devDependency') }}
                  </mat-chip>
                  <mat-chip class="transitive-chip" *ngIf="isPackageLockFile()">
                    <mat-icon>account_tree</mat-icon>
                    é–“æ¥ç›¸ä¾ {{ getDependencyCount('transitive') }}
                  </mat-chip>
                </mat-chip-set>
              </div>

              <!-- æƒææ¨¡å¼é¸æ“‡ -->
              <div class="scan-mode-section" *ngIf="packages.length > 0">
                <mat-expansion-panel>
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon>settings</mat-icon>
                      æƒæè¨­å®š
                    </mat-panel-title>
                    <mat-panel-description>
                      {{ getCurrentModeDescription() }}
                    </mat-panel-description>
                  </mat-expansion-panel-header>
                  
                  <div class="scan-mode-content">
                    <h4>æƒæç¯„åœï¼š</h4>
                    
                    <mat-radio-group 
                      [value]="currentScanConfig.mode" 
                      (change)="onScanModeChange($event.value)">
                      
                      <div class="scan-mode-options">
                        <mat-radio-button 
                          *ngFor="let mode of scanModes" 
                          [value]="mode.value"
                          class="scan-mode-option">
                          
                          <div class="mode-content">
                            <div class="mode-header">
                              <mat-icon [class]="'mode-icon-' + mode.value">{{ mode.icon }}</mat-icon>
                              <span class="mode-label">{{ mode.label }}</span>
                              <span class="mode-badge" *ngIf="mode.value === 'balanced'">æ¨è–¦</span>
                            </div>
                            <p class="mode-description">{{ getSimplifiedModeDescription(mode.value) }}</p>
                          </div>
                        </mat-radio-button>
                      </div>
                    </mat-radio-group>

                    <div class="scan-stats" *ngIf="allPackages.length > 0">
                      <mat-icon>info</mat-icon>
                      <span>{{ getScanStats() }}</span>
                      <span *ngIf="estimatedScanTime" class="time-estimate">
                        (é ä¼°æ™‚é–“: {{ estimatedScanTime.estimatedMinutes }} åˆ†é˜)
                      </span>
                    </div>
                  </div>
                </mat-expansion-panel>
              </div>

            </div>

            <!-- å¥—ä»¶æ¸…å–®æŠ˜ç–Šé¢æ¿ -->
            <div class="packages-list-section">
              <mat-expansion-panel [expanded]="showPackagesList" (expandedChange)="showPackagesList = $event">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon>list_alt</mat-icon>
                    å¥—ä»¶è©³ç´°æ¸…å–®
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ showPackagesList ? 'éš±è—' : 'é¡¯ç¤º' }} {{ packages.length }} å€‹å¥—ä»¶çš„è©³ç´°è³‡è¨Š
                  </mat-panel-description>
                </mat-expansion-panel-header>
                
                <!-- è™›æ“¬æ»¾å‹•å¥—ä»¶è¡¨æ ¼ -->
                <div class="virtual-scroll-container">
                  <cdk-virtual-scroll-viewport itemSize="48" minBufferPx="200" maxBufferPx="400" class="packages-viewport">
                    <div class="packages-table-header">
                      <div class="header-row">
                        <div class="header-cell name-column">å¥—ä»¶åç¨±</div>
                        <div class="header-cell version-column">ç‰ˆæœ¬</div>
                        <div class="header-cell type-column">é¡å‹</div>
                      </div>
                    </div>
                    
                    <div *cdkVirtualFor="let package of packages; trackBy: trackByPackageName" 
                         class="package-row">
                      <div class="package-cell name-column" [matTooltip]="package.name">
                        {{ package.name }}
                      </div>
                      <div class="package-cell version-column">
                        {{ package.version }}
                      </div>
                      <div class="package-cell type-column">
                        <mat-chip [class]="'type-' + package.type" class="package-type-chip">
                          {{ package.type === 'dependency' ? 'æ­£å¼' : 
                             package.type === 'devDependency' ? 'é–‹ç™¼' : 'é–“æ¥' }}
                        </mat-chip>
                      </div>
                    </div>
                  </cdk-virtual-scroll-viewport>
                </div>
              </mat-expansion-panel>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>
                <mat-icon>arrow_back</mat-icon>
                ä¸Šä¸€æ­¥
              </button>
              <button mat-raised-button 
                      color="accent" 
                      (click)="startScan()"
                      [disabled]="packages.length === 0">
                <mat-icon>play_arrow</mat-icon>
                é–‹å§‹æƒæ ({{ packages.length }} å€‹å¥—ä»¶)
              </button>
            </div>
          </div>
        </mat-step>
      </mat-stepper>
    </mat-card-content>
  </mat-card>

  <!-- å¹«åŠ©è³‡è¨Š -->
  <mat-card class="help-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>help_outline</mat-icon>
        ä½¿ç”¨æ­¥é©Ÿ
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="help-steps">
        <div class="help-step">
          <div class="step-number">1</div>
          <div>
            <h4>ä¸Šå‚³æª”æ¡ˆ</h4>
            <p>é¸æ“‡å°ˆæ¡ˆä¸­çš„ package.json</p>
          </div>
        </div>
        <div class="help-step">
          <div class="step-number">2</div>
          <div>
            <h4>é–‹å§‹æƒæ</h4>
            <p>é»æ“ŠæƒææŒ‰éˆ•å³å¯</p>
          </div>
        </div>
      </div>
      
      <div class="faq-section">
        <div class="faq-item">
          <strong>ğŸ’¡ æª”æ¡ˆä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨ï¼Œåœ¨æœ¬åœ°è™•ç†</strong>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>