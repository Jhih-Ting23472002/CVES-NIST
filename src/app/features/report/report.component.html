<div class="report-container">
  <!-- 報告標題 -->
  <header class="report-header">
    <div class="header-content">
      <h1>
        <mat-icon>assessment</mat-icon>
        安全掃描報告
      </h1>
      <div class="report-summary">
        <span class="packages-count">{{ packages.length }} 個套件</span>
        <span class="vulnerabilities-count">{{ getTotalVulnerabilities() }} 個漏洞</span>
        <time class="scan-time">
          <mat-icon>schedule</mat-icon>
          {{ formatScanTimestamp() }}
        </time>
      </div>
    </div>
  </header>
  
  <!-- 黏性操作工具列 -->
  <nav class="sticky-actions">
    <div class="action-group">
      <button mat-stroked-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        返回掃描
      </button>
      
      <button mat-flat-button color="primary" (click)="startNewScan()">
        <mat-icon>refresh</mat-icon>
        新的掃描
      </button>
    </div>
    
    <div class="export-group">
      <span class="export-label">匯出報告：</span>
      
      <button mat-button (click)="exportAsJson()">
        <mat-icon>code</mat-icon>
        JSON
      </button>
      
      <button mat-button (click)="exportAsCsv()">
        <mat-icon>table_chart</mat-icon>
        CSV
      </button>
      
      <button mat-button (click)="exportAsHtml()">
        <mat-icon>description</mat-icon>
        HTML
      </button>
      
      <button mat-button (click)="exportAsSbomHtml()">
        <mat-icon>security</mat-icon>
        SBOM HTML
      </button>
      
      <button mat-button [matMenuTriggerFor]="sbomMenu">
        <mat-icon>inventory</mat-icon>
        SBOM
        <mat-icon>expand_more</mat-icon>
      </button>
      
      <mat-menu #sbomMenu="matMenu">
        <div mat-subheader>CycloneDX</div>
        <button mat-menu-item (click)="exportAsCycloneDX(false)">
          <span>僅套件清單</span>
        </button>
        <button mat-menu-item (click)="exportAsCycloneDX(true)">
          <span>包含漏洞資訊</span>
        </button>
        <mat-divider></mat-divider>
        <div mat-subheader>SPDX</div>
        <button mat-menu-item (click)="exportAsSpdx(false)">
          <span>僅套件清單</span>
        </button>
        <button mat-menu-item (click)="exportAsSpdx(true)">
          <span>包含漏洞資訊</span>
        </button>
      </mat-menu>
    </div>
  </nav>
  
  <!-- 關鍵指標 -->
  <section class="metrics-overview">
    <div class="metric-grid">
      <div class="metric critical" *ngIf="getSeverityCount('CRITICAL') > 0">
        <span class="metric-value">{{ getSeverityCount('CRITICAL') }}</span>
        <span class="metric-label">嚴重</span>
      </div>
      
      <div class="metric high" *ngIf="getSeverityCount('HIGH') > 0">
        <span class="metric-value">{{ getSeverityCount('HIGH') }}</span>
        <span class="metric-label">高風險</span>
      </div>
      
      <div class="metric medium" *ngIf="getSeverityCount('MEDIUM') > 0">
        <span class="metric-value">{{ getSeverityCount('MEDIUM') }}</span>
        <span class="metric-label">中風險</span>
      </div>
      
      <div class="metric low" *ngIf="getSeverityCount('LOW') > 0">
        <span class="metric-value">{{ getSeverityCount('LOW') }}</span>
        <span class="metric-label">低風險</span>
      </div>
      
      <div class="metric safe">
        <span class="metric-value">{{ getSafePackagesCount() }}</span>
        <span class="metric-label">安全</span>
      </div>
    </div>
  </section>

  <!-- 主要內容頁籤 -->
  <mat-tab-group class="report-tabs">
    <!-- 風險分析頁籤 -->
    <mat-tab label="風險分析">
      <div class="tab-content">
        <div class="tab-header">
          <h3>
            <mat-icon>analytics</mat-icon>
            風險評估與安全建議
          </h3>
        </div>
        
        <!-- 風險分析圖表 -->
        <div class="chart-section" *ngIf="getTotalVulnerabilities() > 0">
          <h4>風險分佈</h4>
          <div class="chart-wrapper">
            <canvas baseChart
                    [data]="doughnutChartData"
                    type="doughnut"
                    [options]="doughnutChartOptions">
            </canvas>
          </div>
        </div>
        
        <div class="analysis-content">
          <div class="risk-analysis">
              <div class="analysis-section" *ngIf="getSeverityCount('CRITICAL') > 0">
                <h4 class="critical-title">
                  <mat-icon>dangerous</mat-icon>
                  嚴重風險警告
                </h4>
                <p>發現 <strong>{{ getSeverityCount('CRITICAL') }}</strong> 個嚴重等級漏洞，建議立即處理。</p>
                
                <div class="official-recommendations">
                  <h5><mat-icon>shield</mat-icon>NIST 官方建議</h5>
                  <ul>
                    <li><strong>立即行動</strong>：根據 NIST SP 800-40 指引，嚴重漏洞應在發現後 72 小時內修復</li>
                    <li><strong>風險評估</strong>：依據 NIST RMF，評估對機密性、完整性、可用性的影響</li>
                    <li><strong>應急回應</strong>：參考 NIST SP 800-61 資安事件處理指南</li>
                    <li><strong>持續監控</strong>：實施 NIST SP 800-137 持續監控策略</li>
                  </ul>
                </div>
                
                <div class="action-items">
                  <h5><mat-icon>task_alt</mat-icon>建議行動</h5>
                  <ul>
                    <li>立即更新相關套件至安全版本</li>
                    <li>評估是否需要暫時停用相關功能</li>
                    <li>監控系統日誌以檢測可能的攻擊嘗試</li>
                    <li>通知相關利害關係人和管理層</li>
                  </ul>
                </div>
              </div>
              
              <div class="analysis-section" *ngIf="getSeverityCount('HIGH') > 0">
                <h4 class="high-title">
                  <mat-icon>warning</mat-icon>
                  高風險項目
                </h4>
                <p>發現 <strong>{{ getSeverityCount('HIGH') }}</strong> 個高風險漏洞，建議優先處理。</p>
                
                <div class="official-recommendations">
                  <h5><mat-icon>security</mat-icon>最佳實務</h5>
                  <ul>
                    <li><strong>修復時程</strong>：依據 CISA 指引，高風險漏洞應在 15 天內修復</li>
                    <li><strong>優先排序</strong>：使用 CVSS 評分系統評估修復優先順序</li>
                    <li><strong>暫時緩解</strong>：實施網路分段、存取控制等暫時性防護措施</li>
                  </ul>
                </div>
                
                <div class="action-items">
                  <h5><mat-icon>schedule</mat-icon>行動計畫</h5>
                  <ul>
                    <li>規劃套件更新時程</li>
                    <li>評估業務影響和修復成本</li>
                    <li>加強相關模組的監控</li>
                    <li>建立回退計畫和測試程序</li>
                  </ul>
                </div>
              </div>
              
              <div class="analysis-section" *ngIf="getSeverityCount('MEDIUM') > 0 || getSeverityCount('LOW') > 0">
                <h4 class="medium-title">
                  <mat-icon>info</mat-icon>
                  一般風險項目
                </h4>
                <p>發現 <strong>{{ getSeverityCount('MEDIUM') + getSeverityCount('LOW') }}</strong> 個中低風險漏洞。</p>
                
                <div class="official-recommendations">
                  <h5><mat-icon>update</mat-icon>維護建議</h5>
                  <ul>
                    <li><strong>定期更新</strong>：建立定期更新週期，中風險漏洞 30 天內、低風險漏洞 90 天內修復</li>
                    <li><strong>自動化管理</strong>：使用 Dependabot、Renovate 等工具自動化依賴套件管理</li>
                    <li><strong>測試驗證</strong>：建立完整的測試流程確保更新不影響功能</li>
                  </ul>
                </div>
                
                <div class="action-items">
                  <h5><mat-icon>assignment</mat-icon>維護計畫</h5>
                  <ul>
                    <li>納入定期維護計畫</li>
                    <li>持續關注安全更新</li>
                    <li>考慮在下次大版本更新時一併處理</li>
                    <li>建立漏洞追蹤和管理流程</li>
                  </ul>
                </div>
              </div>
              
              <div class="analysis-section recommendations">
                <h4>
                  <mat-icon>lightbulb</mat-icon>
                  安全建議
                </h4>
                <ul>
                  <li>定期執行安全掃描（建議每週一次）</li>
                  <li>建立自動化安全更新流程</li>
                  <li>訂閱相關套件的安全通知</li>
                  <li>建立漏洞應變處理流程</li>
                  <li>考慮引入 Dependabot 等工具自動化管理</li>
                </ul>
              </div>
          </div>
        </div>
      </div>
    </mat-tab>

    <!-- 套件清單頁籤 -->
    <mat-tab label="套件清單">
      <div class="tab-content">
        <div class="tab-header">
          <h3>
            <mat-icon>inventory</mat-icon>
            套件清單與風險評估
          </h3>
          <p>顯示所有掃描的套件及其安全狀態</p>
        </div>
        
        <!-- 套件統計 -->
        <div class="package-stats">
          <div class="stat-item">
            <span class="stat-value">{{ packages.length }}</span>
            <span class="stat-name">總套件數</span>
          </div>
          <div class="stat-item vulnerable" *ngIf="getVulnerablePackagesCount() > 0">
            <span class="stat-value">{{ getVulnerablePackagesCount() }}</span>
            <span class="stat-name">有漏洞</span>
          </div>
          <div class="stat-item safe">
            <span class="stat-value">{{ getSafePackagesCount() }}</span>
            <span class="stat-name">安全</span>
          </div>
        </div>

        <!-- 套件列表（使用與漏洞表格相同的樣式） -->
        <app-package-table 
          [packages]="packages"
          [scanResults]="scanResults">
        </app-package-table>
      </div>
    </mat-tab>

    <!-- 所有漏洞頁籤 -->
    <mat-tab label="所有漏洞">
      <div class="tab-content">
        <div class="tab-header">
          <h3>
            <mat-icon>bug_report</mat-icon>
            漏洞詳細清單
          </h3>
          <p>顯示所有發現的安全漏洞詳細資訊 ({{ getTotalVulnerabilities() }} 個漏洞)</p>
        </div>
        
        <app-vulnerability-table 
          [scanResults]="scanResults">
        </app-vulnerability-table>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>